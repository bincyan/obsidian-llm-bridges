name: Release Obsidian Plugin

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Get tag version
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Verify version matches tag
        run: |
          TAG_VERSION="${{ steps.version.outputs.tag }}"
          MANIFEST_VERSION=$(jq -r '.version' manifest.json)
          MIN_APP_VERSION=$(jq -r --arg v "$TAG_VERSION" '.[$v] // ""' versions.json)

          echo "Tag version: $TAG_VERSION"
          echo "Manifest version: $MANIFEST_VERSION"
          echo "versions.json entry: ${MIN_APP_VERSION:-<missing>}"

          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "❌ Tag ($TAG_VERSION) does not match manifest ($MANIFEST_VERSION)"
            exit 1
          fi

          if [ -z "$MIN_APP_VERSION" ]; then
            echo "❌ versions.json is missing an entry for $TAG_VERSION"
            exit 1
          fi

      - name: Verify build outputs
        run: |
          echo "Verifying build outputs..."
          if [ ! -f main.js ] || [ ! -s main.js ]; then
            echo "❌ main.js not found or empty"
            exit 1
          fi
          echo "✅ main.js exists: $(wc -c < main.js) bytes"
          echo "✅ manifest.json exists: $(wc -c < manifest.json) bytes"

      - name: Create Release with Assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          # Check if release exists
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "Release $TAG already exists, deleting..."
            gh release delete "$TAG" --yes
          fi

          # Determine if prerelease
          PRERELEASE_FLAG=""
          if [[ "$TAG" == *"-"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          # Prepare assets
          ASSETS="main.js manifest.json"
          if [ -f styles.css ]; then
            ASSETS="$ASSETS styles.css"
          fi

          # Create release with assets
          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes \
            $PRERELEASE_FLAG \
            $ASSETS

          echo "✅ Release $TAG created with assets: $ASSETS"
