name: CI

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

jobs:
  # ============================================================================
  # Build and Test
  # ============================================================================
  test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Build MCP server
        run: npm run build:mcp

      - name: Run tests
        run: npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
          retention-days: 7

  # ============================================================================
  # Manifest Validation
  # ============================================================================
  validate-manifest:
    name: Validate Manifest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate manifest.json structure
        run: |
          echo "Validating manifest.json..."

          # Check required fields exist
          for field in id name version minAppVersion description author; do
            if ! jq -e ".$field" manifest.json > /dev/null 2>&1; then
              echo "❌ Missing required field: $field"
              exit 1
            fi
          done

          # Validate id format (lowercase, numbers, hyphens only)
          ID=$(jq -r '.id' manifest.json)
          if ! echo "$ID" | grep -qE '^[a-z0-9-]+$'; then
            echo "❌ Invalid id format: $ID (must be lowercase letters, numbers, hyphens)"
            exit 1
          fi

          # Validate version is semver
          VERSION=$(jq -r '.version' manifest.json)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid version format: $VERSION (must be semver x.y.z)"
            exit 1
          fi

          # Validate minAppVersion is semver
          MIN_VERSION=$(jq -r '.minAppVersion' manifest.json)
          if ! echo "$MIN_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid minAppVersion format: $MIN_VERSION"
            exit 1
          fi

          echo "✅ manifest.json is valid"

      - name: Check version consistency
        run: |
          echo "Checking version consistency..."

          MANIFEST_VERSION=$(jq -r '.version' manifest.json)
          PACKAGE_VERSION=$(jq -r '.version' package.json)

          if [ "$MANIFEST_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "❌ Version mismatch:"
            echo "   manifest.json: $MANIFEST_VERSION"
            echo "   package.json:  $PACKAGE_VERSION"
            exit 1
          fi

          # Check versions.json has entry for current version
          if ! jq -e ".[\"$MANIFEST_VERSION\"]" versions.json > /dev/null 2>&1; then
            echo "❌ versions.json missing entry for version $MANIFEST_VERSION"
            exit 1
          fi

          echo "✅ Version consistency check passed"

  # ============================================================================
  # Build Artifacts
  # ============================================================================
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [test, validate-manifest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all
        run: npm run build:all

      - name: Verify build outputs
        run: |
          echo "Verifying build outputs..."

          # Check main.js exists and has content
          if [ ! -f main.js ] || [ ! -s main.js ]; then
            echo "❌ main.js not found or empty"
            exit 1
          fi

          # Check MCP server exists
          if [ ! -f dist/mcp-server.js ] || [ ! -s dist/mcp-server.js ]; then
            echo "❌ dist/mcp-server.js not found or empty"
            exit 1
          fi

          echo "✅ Build outputs verified"
          echo "   main.js: $(wc -c < main.js) bytes"
          echo "   dist/mcp-server.js: $(wc -c < dist/mcp-server.js) bytes"

      - name: Create plugin package
        run: |
          mkdir -p release
          cp main.js manifest.json release/
          if [ -f styles.css ]; then cp styles.css release/; fi
          cd release && zip -r ../obsidian-llm-bridges.zip .

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-plugin
          path: |
            main.js
            manifest.json
            styles.css
          retention-days: 30

      - name: Upload MCP server artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server
          path: dist/mcp-server.js
          retention-days: 30

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: obsidian-llm-bridges.zip
          retention-days: 30

  # ============================================================================
  # Code Coverage (optional, on main branch)
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14
